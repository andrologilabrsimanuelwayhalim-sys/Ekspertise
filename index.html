<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Hasil Laboratorium Ekspertise</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #2563eb;
            text-align: center;
            margin-bottom: 10px;
            font-size: 26px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        .input-group { display: flex; flex-direction: column; }
        label {
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 13px;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        input:focus, select:focus { outline: none; border-color: #2563eb; }
        #dokterLainnya { margin-top: 10px; display: none; }
        .btn-group { display: flex; gap: 10px; margin-bottom: 25px; flex-wrap: wrap; }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-add { background: #10b981; color: white; }
        .btn-add:hover:not(:disabled) { background: #059669; }
        .btn-update { background: #f59e0b; color: white; display: none; }
        .btn-update:hover:not(:disabled) { background: #d97706; }
        .btn-cancel { background: #6b7280; color: white; display: none; }
        .btn-cancel:hover { background: #4b5563; }
        .btn-export { background: #2563eb; color: white; }
        .btn-export:hover:not(:disabled) { background: #1d4ed8; }
        .btn-clear { background: #ef4444; color: white; }
        .btn-clear:hover:not(:disabled) { background: #dc2626; }
        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        table { width: 100%; border-collapse: collapse; background: white; font-size: 13px; }
        th {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            color: white;
            padding: 12px 10px;
            text-align: left;
            font-weight: 600;
        }
        td { padding: 10px; border-bottom: 1px solid #e0e0e0; }
        tr:hover { background: #eff6ff; }
        .action-buttons { display: flex; gap: 5px; }
        .btn-edit, .btn-delete {
            color: white;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            border: none;
        }
        .btn-edit { background: #3b82f6; }
        .btn-edit:hover { background: #2563eb; }
        .btn-delete { background: #ef4444; }
        .btn-delete:hover { background: #dc2626; }
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            text-align: center;
        }
        .summary-card h3 { font-size: 12px; margin-bottom: 10px; opacity: 0.9; }
        .summary-card .value { font-size: 28px; font-weight: bold; }
        .monthly-report {
            background: #f8fafc;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }
        .monthly-report h2 {
            color: #2563eb;
            margin-bottom: 20px;
            font-size: 20px;
            text-align: center;
        }
        .month-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .month-card h3 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 18px;
            text-align: center;
            border-bottom: 2px solid #2563eb;
            padding-bottom: 10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-item {
            background: #eff6ff;
            padding: 15px;
            border-radius: 6px;
            text-align: center;
        }
        .stat-item .label { font-size: 11px; color: #64748b; margin-bottom: 5px; }
        .stat-item .value { font-size: 20px; font-weight: bold; color: #2563eb; }
        .signature-section {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid #e2e8f0;
            text-align: center;
        }
        .signature-section .date { color: #64748b; margin-bottom: 40px; font-size: 14px; }
        .signature-section .name { font-weight: bold; color: #1e293b; font-size: 16px; }
        .empty-state { text-align: center; padding: 60px 20px; color: #999; }
        .edit-mode { background: #fef3c7 !important; }
        .alert { padding: 15px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .alert-success { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .alert-info { background: #dbeafe; color: #1e40af; border: 1px solid #3b82f6; }
        .alert-error { background: #fee2e2; color: #991b1b; border: 1px solid #ef4444; }
        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1000;
        }
        .status-online { background: #d1fae5; color: #065f46; }
        .status-offline { background: #fee2e2; color: #991b1b; }
        .status-loading { background: #fef3c7; color: #92400e; }
    </style>
</head>
<body>
    <div id="connectionStatus" class="connection-status status-loading">Menghubungkan...</div>

    <div class="container">
        <h1>üè• Laporan Hasil Laboratorium Ekspertise<br>Dokter Spesialis Andrologi</h1>
        <p class="subtitle">Sistem Pencatatan & Analisis Pemeriksaan Laboratorium</p>
        
        <div class="alert alert-success" id="alertSuccess"><strong>‚úì</strong> <span id="alertSuccessText"></span></div>
        <div class="alert alert-info" id="alertInfo"><strong>‚Ñπ</strong> <span id="alertInfoText"></span></div>
        <div class="alert alert-error" id="alertError"><strong>‚úó</strong> <span id="alertErrorText"></span></div>
        
        <div class="controls">
            <div class="input-group">
                <label>Tanggal Pemeriksaan</label>
                <input type="date" id="tanggal" required>
            </div>
            <div class="input-group">
                <label>Jenis Pemeriksaan</label>
                <select id="jenisPemeriksaan">
                    <option value="Alfa Glucosidase">Alfa Glucosidase</option>
                    <option value="Analisa Aspermia">Analisa Aspermia</option>
                    <option value="Analisa Sperma">Analisa Sperma</option>
                    <option value="DNA Fragmentasi">DNA Fragmentasi</option>
                    <option value="Fructose">Fructose</option>
                    <option value="Preparasi Sperma">Preparasi Sperma</option>
                    <option value="Sitrat">Sitrat</option>
                    <option value="Urine Post Ejakulasi">Urine Post Ejakulasi</option>
                    <option value="Zinc">Zinc</option>
                </select>
            </div>
            <div class="input-group">
                <label>Jumlah Pasien</label>
                <input type="number" id="jumlah" min="1" value="1">
            </div>
            <div class="input-group">
                <label>Dokter Penanggung Jawab</label>
                <select id="dokter">
                    <option value="dr. Ahmad Ricardo Syukur Silalahi, Sp.And">dr. Ahmad Ricardo Syukur Silalahi, Sp.And</option>
                    <option value="David Martua Sitinjak, S.Tr.Kes.">David Martua Sitinjak, S.Tr.Kes.</option>
                    <option value="Viorentin Natalia Moi, S.Tr.Kes.">Viorentin Natalia Moi, S.Tr.Kes.</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
                <input type="text" id="dokterLainnya" placeholder="Masukkan nama dokter">
            </div>
        </div>
        
        <div class="btn-group">
            <button class="btn-add" id="btnAdd">‚ûï Tambah Data</button>
            <button class="btn-update" id="btnUpdate">üíæ Simpan</button>
            <button class="btn-cancel" id="btnCancel">‚úñ Batal</button>
            <button class="btn-export" id="btnExport">üì• Export Excel</button>
            <button class="btn-clear" id="btnClear">üóëÔ∏è Hapus Semua</button>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Tanggal</th>
                        <th>Hari</th>
                        <th>Jenis Pemeriksaan</th>
                        <th>Jumlah</th>
                        <th>Dokter</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <tr><td colspan="7" class="empty-state">Memuat data...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="summary" id="summary" style="display: none;"></div>
        <div class="monthly-report" id="monthlyReport" style="display: none;">
            <h2>üìä Laporan Bulanan</h2>
            <div id="monthlyReportContainer"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, push, remove, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCAdMBhOx6vbLG9kK187KndVI5TY_SsP9M",
            authDomain: "expertise-f7649.firebaseapp.com",
            databaseURL: "https://expertise-f7649-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "expertise-f7649",
            storageBucket: "expertise-f7649.firebasestorage.app",
            messagingSenderId: "13801587228",
            appId: "1:13801587228:web:6cc283c65178d9195255d9",
            measurementId: "G-ZT1BDBXDX8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const dataRef = ref(db, 'labData');

        let dataArray = [];
        let editKey = null;
        const hari = ['Minggu','Senin','Selasa','Rabu','Kamis','Jumat','Sabtu'];
        const bulan = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
        
        document.getElementById('tanggal').valueAsDate = new Date();
        
        function updateStatus(status) {
            const el = document.getElementById('connectionStatus');
            el.className = 'connection-status status-' + status;
            el.textContent = status === 'online' ? '‚úì Terhubung' : status === 'offline' ? '‚úó Offline' : 'Menghubungkan...';
        }

        onValue(dataRef, (snapshot) => {
            dataArray = [];
            if (snapshot.exists()) {
                const data = snapshot.val();
                Object.keys(data).forEach(key => {
                    dataArray.push({ key: key, ...data[key] });
                });
                dataArray.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
                updateStatus('online');
            } else {
                updateStatus('online');
            }
            tampilkanData();
        }, (error) => {
            console.error(error);
            updateStatus('offline');
            showAlert('error', 'Gagal terhubung: ' + error.message);
        });
        
        function showAlert(type, msg) {
            ['alertSuccess','alertInfo','alertError'].forEach(id => 
                document.getElementById(id).style.display = 'none'
            );
            const alert = document.getElementById('alert' + type.charAt(0).toUpperCase() + type.slice(1));
            document.getElementById(alert.id + 'Text').textContent = msg;
            alert.style.display = 'block';
            setTimeout(() => alert.style.display = 'none', 3000);
        }
        
        function toggleDokterLainnya() {
            const sel = document.getElementById('dokter');
            const inp = document.getElementById('dokterLainnya');
            inp.style.display = sel.value === 'Lainnya' ? 'block' : 'none';
        }
        
        async function tambahData() {
            const tgl = document.getElementById('tanggal').value;
            const jenis = document.getElementById('jenisPemeriksaan').value;
            const jml = parseInt(document.getElementById('jumlah').value);
            const dok = document.getElementById('dokter').value;
            const dokLain = document.getElementById('dokterLainnya').value;
            
            if (!tgl) return showAlert('error', 'Pilih tanggal!');
            if (isNaN(jml) || jml < 1) return showAlert('error', 'Jumlah minimal 1!');
            
            let dokter = dok === 'Lainnya' ? dokLain.trim() : dok;
            if (!dokter) return showAlert('error', 'Masukkan nama dokter!');
            
            const date = new Date(tgl + 'T00:00:00');
            const newData = {
                tanggal: tgl,
                hari: hari[date.getDay()],
                jenis: jenis,
                jumlah: jml,
                dokter: dokter,
                timestamp: Date.now()
            };
            
            try {
                await push(dataRef, newData);
                resetForm();
                showAlert('success', 'Data berhasil ditambahkan!');
            } catch (error) {
                showAlert('error', 'Gagal: ' + error.message);
            }
        }
        
        function editData(key) {
            const item = dataArray.find(d => d.key === key);
            if (!item) return;
            
            editKey = key;
            document.getElementById('tanggal').value = item.tanggal;
            document.getElementById('jenisPemeriksaan').value = item.jenis;
            document.getElementById('jumlah').value = item.jumlah;
            
            const dokSel = document.getElementById('dokter');
            const opts = Array.from(dokSel.options).map(o => o.value);
            if (opts.includes(item.dokter)) {
                dokSel.value = item.dokter;
            } else {
                dokSel.value = 'Lainnya';
                document.getElementById('dokterLainnya').value = item.dokter;
            }
            toggleDokterLainnya();
            
            document.getElementById('btnAdd').style.display = 'none';
            document.getElementById('btnUpdate').style.display = 'inline-block';
            document.getElementById('btnCancel').style.display = 'inline-block';
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        async function updateData() {
            const tgl = document.getElementById('tanggal').value;
            const jenis = document.getElementById('jenisPemeriksaan').value;
            const jml = parseInt(document.getElementById('jumlah').value);
            const dok = document.getElementById('dokter').value;
            const dokLain = document.getElementById('dokterLainnya').value;
            
            if (!tgl) return showAlert('error', 'Pilih tanggal!');
            if (isNaN(jml) || jml < 1) return showAlert('error', 'Jumlah minimal 1!');
            
            let dokter = dok === 'Lainnya' ? dokLain.trim() : dok;
            if (!dokter) return showAlert('error', 'Masukkan nama dokter!');
            
            const date = new Date(tgl + 'T00:00:00');
            const updData = {
                tanggal: tgl,
                hari: hari[date.getDay()],
                jenis: jenis,
                jumlah: jml,
                dokter: dokter,
                timestamp: Date.now()
            };
            
            try {
                await update(ref(db, 'labData/' + editKey), updData);
                batalEdit();
                showAlert('success', 'Data berhasil diperbarui!');
            } catch (error) {
                showAlert('error', 'Gagal: ' + error.message);
            }
        }
        
        function batalEdit() {
            editKey = null;
            document.getElementById('btnAdd').style.display = 'inline-block';
            document.getElementById('btnUpdate').style.display = 'none';
            document.getElementById('btnCancel').style.display = 'none';
            resetForm();
        }
        
        function resetForm() {
            document.getElementById('tanggal').valueAsDate = new Date();
            document.getElementById('jenisPemeriksaan').selectedIndex = 0;
            document.getElementById('jumlah').value = 1;
            document.getElementById('dokter').selectedIndex = 0;
            document.getElementById('dokterLainnya').value = '';
            toggleDokterLainnya();
        }
        
        function tampilkanData() {
            const tbody = document.getElementById('tableBody');
            
            if (dataArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">Belum ada data</td></tr>';
                document.getElementById('summary').style.display = 'none';
                document.getElementById('monthlyReport').style.display = 'none';
                return;
            }
            
            tbody.innerHTML = '';
            const jenisCount = {};
            let totalPasien = 0;
            
            dataArray.forEach((item, i) => {
                const row = tbody.insertRow();
                row.className = editKey === item.key ? 'edit-mode' : '';
                row.innerHTML = `
                    <td>${i + 1}</td>
                    <td>${formatTanggal(item.tanggal)}</td>
                    <td>${item.hari}</td>
                    <td>${item.jenis}</td>
                    <td>${item.jumlah}</td>
                    <td>${item.dokter}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-edit" data-key="${item.key}">‚úèÔ∏è</button>
                            <button class="btn-delete" data-key="${item.key}">üóëÔ∏è</button>
                        </div>
                    </td>
                `;
                
                jenisCount[item.jenis] = (jenisCount[item.jenis] || 0) + item.jumlah;
                totalPasien += item.jumlah;
            });
            
            document.querySelectorAll('.btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    editData(this.getAttribute('data-key'));
                });
            });
            
            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    hapusData(this.getAttribute('data-key'));
                });
            });
            
            const summaryDiv = document.getElementById('summary');
            summaryDiv.innerHTML = `
                <div class="summary-card">
                    <h3>Total Pasien</h3>
                    <div class="value">${totalPasien}</div>
                </div>
            `;
            
            Object.keys(jenisCount).sort().forEach(jenis => {
                summaryDiv.innerHTML += `
                    <div class="summary-card">
                        <h3>${jenis}</h3>
                        <div class="value">${jenisCount[jenis]}</div>
                    </div>
                `;
            });
            summaryDiv.style.display = 'grid';
            
            // Monthly report
            const monthlyData = {};
            dataArray.forEach(item => {
                const date = new Date(item.tanggal + 'T00:00:00');
                const monthYear = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { totalPasien: 0, jenis: {}, dokter: {} };
                }
                
                monthlyData[monthYear].totalPasien += item.jumlah;
                monthlyData[monthYear].jenis[item.jenis] = (monthlyData[monthYear].jenis[item.jenis] || 0) + item.jumlah;
                monthlyData[monthYear].dokter[item.dokter] = (monthlyData[monthYear].dokter[item.dokter] || 0) + item.jumlah;
            });
            
            const container = document.getElementById('monthlyReportContainer');
            container.innerHTML = '';
            
            Object.keys(monthlyData).sort().reverse().forEach(monthYear => {
                const [year, month] = monthYear.split('-');
                const monthName = bulan[parseInt(month) - 1];
                const stats = monthlyData[monthYear];
                
                let html = '<div class="stats-grid">';
                html += `<div class="stat-item"><div class="label">Total</div><div class="value">${stats.totalPasien}</div></div>`;
                
                Object.keys(stats.jenis).sort().forEach(jenis => {
                    const pct = ((stats.jenis[jenis] / stats.totalPasien) * 100).toFixed(1);
                    html += `<div class="stat-item"><div class="label">${jenis}</div><div class="value">${stats.jenis[jenis]} (${pct}%)</div></div>`;
                });
                html += '</div>';
                
                Object.keys(stats.dokter).sort().forEach(dokter => {
                    const pct = ((stats.dokter[dokter] / stats.totalPasien) * 100).toFixed(1);
                    const today = new Date();
                    const todayStr = `${today.getDate()} ${bulan[today.getMonth()]} ${today.getFullYear()}`;
                    
                    html += `
                        <div class="signature-section">
                            <div class="date">${todayStr}</div>
                            <div style="margin-bottom: 10px; color: #64748b;">
                                Jumlah Pasien: <strong style="color: #2563eb;">${stats.dokter[dokter]}</strong> 
                                dari ${stats.totalPasien} (${pct}%)
                            </div>
                            <div style="margin: 50px 0 10px; font-style: italic; color: #94a3b8;">( tanda tangan )</div>
                            <div class="name">${dokter}</div>
                        </div>
                    `;
                });
                
                container.innerHTML += `<div class="month-card"><h3>üìÖ ${monthName} ${year}</h3>${html}</div>`;
            });
            
            document.getElementById('monthlyReport').style.display = 'block';
        }
        
        function formatTanggal(tgl) {
            const date = new Date(tgl + 'T00:00:00');
            return date.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        async function hapusData(key) {
            const item = dataArray.find(d => d.key === key);
            if (!item) return;
            
            if (confirm(`Hapus data ${item.jenis} tanggal ${formatTanggal(item.tanggal)}?`)) {
                try {
                    await remove(ref(db, 'labData/' + key));
                    showAlert('success', 'Data dihapus!');
                } catch (error) {
                    showAlert('error', 'Gagal hapus: ' + error.message);
                }
            }
        }
        
        async function hapusSemua() {
            if (dataArray.length === 0) return showAlert('error', 'Tidak ada data!');
            if (confirm('Hapus semua data?')) {
                try {
                    await remove(dataRef);
                    batalEdit();
                    showAlert('success', 'Semua data dihapus!');
                } catch (error) {
                    showAlert('error', 'Gagal: ' + error.message);
                }
            }
        }
        
        function exportToExcel() {
            if (dataArray.length === 0) return showAlert('error', 'Tidak ada data!');
            
            const excelData = dataArray.map((item, i) => ({
                'No': i + 1,
                'Tanggal': formatTanggal(item.tanggal),
                'Hari': item.hari,
                'Jenis': item.jenis,
                'Jumlah': item.jumlah,
                'Dokter': item.dokter
            }));
            
            const ws = XLSX.utils.json_to_sheet(excelData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Laporan Lab');
            
            const filename = `Laporan_Lab_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, filename);
            showAlert('success', 'Excel berhasil diunduh!');
        }
        
        document.getElementById('dokter').addEventListener('change', toggleDokterLainnya);
        document.getElementById('btnAdd').addEventListener('click', tambahData);
        document.getElementById('btnUpdate').addEventListener('click', updateData);
        document.getElementById('btnCancel').addEventListener('click', batalEdit);
        document.getElementById('btnExport').addEventListener('click', exportToExcel);
        document.getElementById('btnClear').addEventListener('click', hapusSemua);
    </script>
</body>
</html>
